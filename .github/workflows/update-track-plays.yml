name: ğŸ¤– Actualizar Reproducciones de Canciones

on:
  schedule:
    # Ejecutar cada dÃ­a a las 10:00 AM UTC
    - cron: '0 10 * * *'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Tipo de actualizaciÃ³n'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - ep_only
        - popular_only

permissions:
  contents: write
  pull-requests: write

jobs:
  update-track-plays:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ğŸ“¦ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: ğŸµ Actualizar con datos REALES de Spotify
      run: |
        echo "ğŸµ Actualizando con datos REALES de Spotify..."
        python manual_spotify_updater.py
    
    - name: ğŸ“Š Verificar cambios
      id: check_changes
      run: |
        if git diff --quiet data/music/discography.json; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸  No hay cambios en las reproducciones"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "âœ… Se detectaron cambios en las reproducciones"
          git diff data/music/discography.json
        fi
    
    - name: ğŸ’¾ Commit y push cambios
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Crear mensaje de commit
        TIMESTAMP=$(date '+%Y-%m-%d %H:%M')
        COMMIT_MSG="ğŸ¤– Auto-update track plays: $TIMESTAMP"
        
        git add data/music/discography.json
        git commit -m "$COMMIT_MSG"
        git push origin main
        
        echo "âœ… Cambios subidos exitosamente"
    
    - name: ğŸ“ˆ Resumen de actualizaciÃ³n
      run: |
        echo "ğŸ‰ ActualizaciÃ³n de reproducciones completada"
        echo "ğŸ“… Timestamp: $(date)"
        echo "ğŸ”„ Repositorio actualizado automÃ¡ticamente"
        
        if [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
          echo "âœ… Se actualizaron las reproducciones de las canciones"
        else
          echo "â„¹ï¸  No se detectaron cambios en las reproducciones"
        fi
