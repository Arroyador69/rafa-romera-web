name: 🤖 Actualizar Reproducciones de Canciones

on:
  schedule:
    # Ejecutar cada día a las 10:00 AM UTC
    - cron: '0 10 * * *'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Tipo de actualización'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - ep_only
        - popular_only

permissions:
  contents: write
  pull-requests: write

jobs:
  update-track-plays:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout código
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: 🐍 Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: 📦 Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: 🎵 Actualizar con datos REALES de Spotify
      run: |
        echo "🎵 Actualizando con datos REALES de Spotify..."
        python manual_spotify_updater.py
    
    - name: 📊 Verificar cambios
      id: check_changes
      run: |
        if git diff --quiet data/music/discography.json; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "ℹ️  No hay cambios en las reproducciones"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "✅ Se detectaron cambios en las reproducciones"
          git diff data/music/discography.json
        fi
    
    - name: 💾 Commit y push cambios
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Crear mensaje de commit
        TIMESTAMP=$(date '+%Y-%m-%d %H:%M')
        COMMIT_MSG="🤖 Auto-update track plays: $TIMESTAMP"
        
        git add data/music/discography.json
        git commit -m "$COMMIT_MSG"
        git push origin main
        
        echo "✅ Cambios subidos exitosamente"
    
    - name: 📈 Resumen de actualización
      run: |
        echo "🎉 Actualización de reproducciones completada"
        echo "📅 Timestamp: $(date)"
        echo "🔄 Repositorio actualizado automáticamente"
        
        if [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
          echo "✅ Se actualizaron las reproducciones de las canciones"
        else
          echo "ℹ️  No se detectaron cambios en las reproducciones"
        fi
